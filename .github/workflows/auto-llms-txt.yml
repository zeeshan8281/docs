name: Auto Update LLMs.txt Files

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - 'docs/base-account/**'
      - 'docs/base-app/**'
      - 'docs/base-chain/**'
      - 'docs/cookbook/**'
      - 'docs/get-started/**'
      - 'docs/learn/**'
      - 'docs/mini-apps/**'
      - 'docs/onchainkit/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  update-llms-txt:
    if: ${{ !startsWith(github.head_ref, 'auto-llms/') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Cursor CLI
        run: |
          curl https://cursor.com/install -fsS | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: Configure git
        run: |
          git config user.name "Cursor Agent"
          git config user.email "cursoragent@cursor.com"

      - name: Post initial comment
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "ü§ñ **LLMs.txt Auto-Update**

          Analyzing documentation changes to update llms.txt files...

          üí° **Want to stop this process?** Comment \`stop\` below and I'll cancel the analysis.

          ‚è±Ô∏è This will timeout after 30 minutes."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update LLMs.txt files
        timeout-minutes: 30
        env:
          MODEL: gpt-5
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_PREFIX: auto-llms
        run: |
          # Expand variables for the agent
          REPO="${{ github.repository }}"
          OWNER="${{ github.repository_owner }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          BASE_REF="${{ github.base_ref }}"
          HEAD_REF="${{ github.head_ref }}"
          BRANCH_PREFIX="${{ env.BRANCH_PREFIX }}"
          
          cursor-agent -p "You are operating in a GitHub Actions runner to automatically update llms.txt and llms-full.txt files.

          The GitHub CLI is available as \`gh\` and authenticated via \`GH_TOKEN\`. Git is available. You have write access to repository contents and can comment on pull requests, but you must not create or edit PRs directly.

          IMPORTANT: Before starting your analysis, use the run_terminal_cmd tool to execute:
          gh pr view ${PR_NUMBER} --json comments --jq '.comments[] | select(.body | contains(\"stop\"))'
          
          If this command returns any results, use run_terminal_cmd to post a cancellation comment on the PR and then use run_terminal_cmd to execute 'exit 0'. Otherwise, proceed with your analysis.

          # Context:
          - Repo: ${REPO}
          - Owner: ${OWNER}
          - PR Number: ${PR_NUMBER}
          - Base Ref: ${BASE_REF}
          - Head Ref: ${HEAD_REF}
          - Branch Prefix: ${BRANCH_PREFIX}

          # Documentation Structure:
          This is a docs repository with the following main directories that each contain llms.txt and llms-full.txt files:
          - docs/base-account/
          - docs/base-app/
          - docs/base-chain/
          - docs/cookbook/
          - docs/get-started/
          - docs/learn/
          - docs/mini-apps/
          - docs/onchainkit/

          # Goal:
          Analyze changes in the original PR and determine if they are significant enough to warrant updating the llms.txt and llms-full.txt files for the affected directories. If so, create a separate PR with the updates.

          # Requirements:
          1) Use run_terminal_cmd to execute \`gh pr diff ${PR_NUMBER}\` to analyze what changed in the original PR
          2) Determine which documentation directories are affected by the changes
          3) Assess if the changes are significant enough to update the llms.txt files (new content, major restructuring, new features, etc.)
          4) If changes are significant:
             - Use run_terminal_cmd to create or update a persistent branch named \`${BRANCH_PREFIX}/pr-${PR_NUMBER}\`
             - Use read_file to read existing llms.txt and llms-full.txt files
             - Use search_replace or write to update the relevant llms.txt and llms-full.txt files
             - Use run_terminal_cmd to push the changes to the branch
             - Use run_terminal_cmd to comment on the original PR with a summary and a compare link
          5) If changes are not significant:
             - Use run_terminal_cmd to comment on the original PR explaining that no llms.txt updates are needed

          # File Format Guidelines:
          - llms.txt files should be concise, focused summaries with key links
          - llms-full.txt files should be comprehensive with all documentation links
          - Follow the existing format and style of the current files
          - Include proper section headers and descriptions
          - Use relative links in the format: https://docs.base.org/[path]

          # Significance Criteria:
          Consider changes significant if they involve:
          - New documentation files or sections
          - Major content restructuring
          - New features or API endpoints
          - Changes to core concepts or workflows
          - New guides or tutorials

          # Deliverables:
          - If updates needed: Pushed commits to the persistent branch and a PR comment with compare link
          - If no updates needed: A brief comment explaining why no updates are required
          - Keep all changes minimal and consistent with existing documentation style
          - Keep the changes to the minimum necessary to update the llms.txt and llms-full.txt files
          
          CRITICAL: After completing ANY of the above actions (stop command, updates completed, or no updates needed), wait 30 seconds and then terminate the process. Do not continue running or use any more tools.
          " --force --model "$MODEL" --output-format=text
